{% extends "base_student.html" %}

{% block title %}Student Dashboard - Smart Attendance System{% endblock %}

{% block head %}
    {{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    {% endblock %}
{% block extra_css %}
<style>
.maindiv {
  background-color: rgba(255, 255, 255, 0.1); /* Semi-transparent white */
  backdrop-filter: blur(10px); /* Apply a blur effect to the background */
  -webkit-backdrop-filter: blur(10px); /* For Safari */
  border-radius: 10px; /* Optional: Rounds the corners */
  padding: 20px; /* Optional: Adds some spacing inside the div */
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Optional: Adds a subtle shadow for depth */
  margin: 10px 0; /* Optional: Adds some spacing around the div */
  height:100%;
}

.charts-container {
  display: flex;
  justify-content: center; /* Center the charts container */
  padding-top: 20px; /* Adjust top padding as needed */
  flex-wrap: wrap; /* Allows items to wrap if needed */

}
.chart-container {
  flex-basis: 50%; /* Each chart container will try to take up half of the container's width */
<!--  max-width: 50%; /* Prevents the chart from taking more than half the width */-->
  box-sizing: border-box; /* Includes padding and border in the element's total width and height */
  padding: 0 20px; /* Adjust padding as needed for spacing around the charts */
}
.pie-chart-container {
  max-width: 300px; /* Adjust this value to make the pie chart smaller or larger */
  margin: auto; /* This will center the chart in the container */
}
.trends-chart-container {
  flex-basis: 60%; /* Increase the basis to give more space */
  max-width: 60%; /* Allows the trends chart to take up more space */
}
</style>
{% endblock %}
{% block content %}
<div>
    <label for="courseFilter">Filter by Course:</label>
    <select id="courseFilter">
    <option value="all">All Courses</option>
    {% for course in courses %}
                <option value="{{ course['course_id'] }}">{{ course['course_name'] }}</option>
<!--            <option value="{{ course }}">{{ course }}</option>-->

    {% endfor %}
</select>

    <label for="monthFilter">Filter by Month:</label>
    <select id="monthFilter">
        <option value="all">All Months</option>
        <option value="01">January</option>
        <option value="02">February</option>
        <option value="03">March</option>
        <option value="04">April</option>
        <option value="05">May</option>
        <option value="06">June</option>
        <option value="07">July</option>
        <option value="08">August</option>
        <option value="09">September</option>
        <option value="10">October</option>
        <option value="11">November</option>
        <option value="12">December</option>
    </select>
</div>

<div class="maindiv">

<div class="charts-container">
    <div class="chart-container pie-chart-container">
        <canvas id="attendanceSummaryChart"></canvas>
    </div>

    <div class="chart-container trends-chart-container">
        <canvas id="attendanceTrendsChart"></canvas>
    </div>
</div>
</div>

<div>
    <!-- Display Risk Status -->
    <h2>Risk Status: {{ risk_status }}</h2>

    <!-- Conditional Display of Risk Status -->
    {% if risk_status == "At Risk" %}
    <div class="badge badge-danger">At Risk</div>
    {% else %}
    <div class="badge badge-success">Not At Risk</div>
    {% endif %}
</div>

{% endblock %}
{% block scripts %}
<script>
    window.onload = function() {
    const urlParams = new URLSearchParams(window.location.search);
    const loginSuccess = urlParams.get('login_success');

    if (loginSuccess === '1') {
        alert('Login successful!');

        // Remove the login_success query parameter
        const newUrl = window.location.href.split('?')[0];
        window.history.replaceState({}, document.title, newUrl);
    }
}

    // Initialize Attendance Summary Chart

var summaryCtx = document.getElementById('attendanceSummaryChart').getContext('2d');
    var attendanceSummaryChart = new Chart(summaryCtx, {
        type: 'pie',
        data: {
            labels: {{ attendance_data.statuses | tojson }},
            datasets: [{
                label: 'Attendance Summary',
                data: {{ attendance_data.counts | tojson }},
                backgroundColor: [
                    // Add more colors as needed
                    'rgba(75, 192, 192, 0.2)',
                    'rgba(255, 99, 132, 0.2)',
                    // ...
                ],
                borderColor: [
                    // Add more colors as needed
                    'rgba(75, 192, 192, 1)',
                    'rgba(255,99,132,1)',
                    // ...
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            tooltips: {
            callbacks: {
                label: function(tooltipItem, data) {
                    var dataset = data.datasets[tooltipItem.datasetIndex];
                    var total = dataset.data.reduce(function(previousValue, currentValue) {
                        return previousValue + currentValue;
                    });
                    var currentValue = dataset.data[tooltipItem.index];
                    var percentage = Math.floor(((currentValue/total) * 100)+0.5);
                    return data.labels[tooltipItem.index] + ": " + percentage + "%";
                }
            }
        }
    }
});


    // Variables to hold the chart instance and original data
    let attendanceTrendsChart = null;
    const originalData = {
        labels: {{ attendance_trends.dates | tojson }},
        counts: {{ attendance_trends.counts | tojson }},
        courseIds: {{ courseIds | tojson }},
     };

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the chart with the original data
        initAttendanceTrendsChart(originalData);

        // Event listeners for the filter dropdowns
        document.getElementById('courseFilter').addEventListener('change', filterAndUpdateChart);
        document.getElementById('monthFilter').addEventListener('change', filterAndUpdateChart);
    });

    function filterAndUpdateChart() {
        const selectedCourse = document.getElementById('courseFilter').value;
        const selectedMonth = document.getElementById('monthFilter').value;

        // Filter the original data based on the selected course and month
        // This is a placeholder - implement this based on your actual data structure and filtering logic
        const filteredData = filterData(originalData, selectedCourse, selectedMonth);

        // Update the chart with the filtered data
        updateAttendanceTrendsChart(filteredData);
    }

    function initAttendanceTrendsChart(data) {
        const ctx = document.getElementById('attendanceTrendsChart').getContext('2d');
        attendanceTrendsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Attendance Trends',
                    data: data.counts,
                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: { y: { beginAtZero: true } },
                responsive: true,
            }
        });
    }

    function updateAttendanceTrendsChart(data) {
        // Update the chart data
        attendanceTrendsChart.data.labels = data.labels;
        attendanceTrendsChart.data.datasets[0].data = data.counts;
        attendanceTrendsChart.update();
    }

    function filterData(data, selectedCourse, selectedMonth) {
    let filteredLabels = [];
    let filteredCounts = [];

    data.labels.forEach((label, index) => {
<!--        const date = new Date(label);-->
        const [year, month, day] = label.split("-");

        const monthMatches = selectedMonth === 'all' ||  month === selectedMonth;
        const courseMatches = selectedCourse === 'all' || data.courseIds[index].toString() === selectedCourse;

        if (monthMatches && courseMatches) {
            filteredLabels.push(label);
            filteredCounts.push(data.counts[index]);
        }
    });

    return { labels: filteredLabels, counts: filteredCounts };
}


<!--    function filterData(data, course, month) {-->
<!--    // Placeholder for filtered data-->
<!--    let filteredLabels = [];-->
<!--    let filteredCounts = [];-->

<!--    // Loop through each entry in the original data-->
<!--    data.labels.forEach((dateStr, index) => {-->
<!--        const dateParts = dateStr.split("-");-->
<!--        const dataMonth = dateParts[1]; // Assuming DD-MM-YYYY format-->

<!--        // If the selected month matches the data month or if 'all' months are selected-->
<!--        if (month === "all" || dataMonth === month) {-->
<!--            filteredLabels.push(dateStr);-->
<!--            filteredCounts.push(data.counts[index]);-->
<!--        }-->
<!--    });-->

<!--    return {-->
<!--        labels: filteredLabels,-->
<!--        counts: filteredCounts-->
<!--    };-->
<!--}-->







<!--    // Initialize Attendance Trends Chart-->
<!--    // Ensure `attendance_trends` data is structured similarly, with `dates` for the x-axis and `counts` for the y-axis.-->
<!--    var trendsCtx = document.getElementById('attendanceTrendsChart').getContext('2d');-->
<!--    var attendanceTrendsChart = new Chart(trendsCtx, {-->
<!--        type: 'line',-->
<!--        data: {-->
<!--            labels: {{ attendance_trends.dates | tojson }},-->
<!--            datasets: [{-->
<!--                label: 'Attendance Trends',-->
<!--                data: {{ attendance_trends.counts | tojson }},-->
<!--                backgroundColor: 'rgba(153, 102, 255, 0.2)',-->
<!--                borderColor: 'rgba(153, 102, 255, 1)',-->
<!--                borderWidth: 1-->
<!--            }]-->
<!--        },-->
<!--        options: {-->
<!--            scales: {-->
<!--                y: {-->
<!--                    beginAtZero: true-->
<!--                }-->
<!--            },-->
<!--            responsive: true,-->
<!--        }-->
<!--    });-->


</script>
{% endblock %}
